<html>

<head>
	<title>RockDice</title>
	<meta charset="utf-8">
	<meta name="viewport"
		content="initial-scale=1.0, width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
	<link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet">
	<script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/0300_LesPaul_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/0280_LesPaul_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/0250_Chaos_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/0170_SBLive_sf2.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/0001_FluidR3_GM_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/0340_Aspirin_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/0390_GeneralUserGS_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/0490_Chaos_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/12835_0_Chaos_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/12838_22_FluidR3_GM_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/12841_26_JCLive_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/12842_26_JCLive_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/12845_26_JCLive_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/12846_26_JCLive_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/12849_26_JCLive_sf2_file.js"></script>
	<script src="https://surikov.github.io/webaudiofontdata/sound/12851_26_JCLive_sf2_file.js"></script>
	<style>
		body {
			padding: 0cm;
			margin: 0cm;
			background-image: url('bg.jpg');
			background-color: #330033;
			background-repeat: no-repeat;
			background-attachment: fixed;
			background-size: cover;
			background-position: center;
			font-family: 'Oswald', sans-serif;
			color: #ffffff;
			user-select: none;
		}

		#editDiv {
			padding: 0cm;
			margin: 0cm;
			background-color: rgba(255, 0, 0, 0.5);
			overflow: hidden;
			position: fixed;
			width: 100%;
			height: 100%;
			z-index: 1;
			display: none;
		}

		#diceDiv {
			padding: 0cm;
			margin: 0cm;
			background-color: rgba(0, 0, 0, 0.75);
			overflow: hidden;
			position: fixed;
			width: 100%;
			height: 100%;
			z-index: 3;
			justify-content: center;

			align-items: center;
			display: flex;
			flex-direction: column;
		}

		.menuStub {
			height: 1.7cm;
			width: 100%;
		}

		.menuDiv {
			overflow: hidden;
			background-color: #556;
			position: fixed;
			bottom: 0;
			width: 100%;
			z-index: 4;
			-webkit-box-shadow: 0px 0px 5px 2px rgba(0, 0, 0, 0.75);
			-moz-box-shadow: 0px 0px 5px 2px rgba(0, 0, 0, 0.75);
			box-shadow: 0px 0px 5px 2px rgba(0, 0, 0, 0.75);
			padding: 0.1cm;
			justify-content: center;
			display: flex;
		}

		.menuButton {
			padding: 0.1cm;
			margin: 0cm;
			width: 1.0cm;
			height: 1.0cm;
			border: none;
			outline: none;
		}

		.diceButton {
			padding-left: 0.2cm;
			padding-right: 0.2cm;
			padding-top: 0.5cm;
			padding-bottom: 0cm;
			margin: 0.0cm;
			width: 2.5cm;
			height: 2.5cm;
		}

		#diceStart {
			padding-left: 0cm;
			padding-right: 0cm;
			padding-top: 0.1cm;
			padding-bottom: 0.5cm;
			margin: 0cm;
			width: 2.5cm;
			height: 2.5cm;
			border: none;
			outline: none;
		}

		.progSlider {
			-webkit-appearance: none;
			width: 100%;
			height: 0.05cm;
			border-radius: 5px;
			background: linear-gradient(90deg, rgba(128, 128, 255, 1) 0%, rgba(0, 255, 255, 1) 50%, rgba(255, 128, 0, 1) 100%);
			outline: none;
			margin: 0px;
			padding: 0px;
		}

		.progSlider::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 0.25cm;
			height: 0.25cm;
			border-radius: 50%;
			background: #fff;
			cursor: pointer;
		}

		.progSlider::-moz-range-thumb {
			width: 0.25cm;
			height: 0.25cm;
			border-radius: 50%;
			background: #fff;
			cursor: pointer;
		}

		#progSliderRow {
			width: 100%;
			padding-left: 0px;
			padding-right: 0px;
			padding-top: 0px;
			padding-bottom: 0.5cm;

		}

		#genControlsRow {
			padding: 0.0cm;
			margin: 0.0cm;
			align-items: center;
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			justify-content: center;
		}

		#roundDrums {
			transform-origin: 50% 50%;
		}

		#roundBass {
			transform-origin: 50% 50%;
		}

		#roundLead {
			transform-origin: 50% 50%;
		}

		#roundPad {
			transform-origin: 50% 50%;
		}

		#eqbars {
			padding: 0cm;
			margin: 0cm;
			overflow: hidden;
			position: fixed;
			width: 100%;
			height: 3cm;
			z-index: 2;
		}
		#svgBars {
			width: 100%;
			height: 3cm;
		}
	</style>
</head>

<body>
	<div id='mainDiv'>
		<div class="menuDiv">
			<input type="image" src='buttonPlay.png' id='menuPlayButton' class='menuButton' onclick='clickPlay();'/>
			<input type="image" src='buttonShare.png' class='menuButton' onclick='clickPlay();'/>
			<input type="image" src='buttonEdit.png' class='menuButton' onclick='clickPlay();'/>
			<input type="image" src='buttonHelp.png' class='menuButton' onclick='clickPlay();'/>
<!--
			<svg version="1.1" id='menuPlayButton' viewBox="0 0 512 512" class='menuButton' onclick="clickPlay();">
				<g>
					<circle cx="256" cy="256" r="180" style="fill:none;stroke:#fff;stroke-width:16;" />
					<text style="font-size:120px;fill:#fff;stroke:none;" x="160" y="300" id='playButtonText'>Play</text>
				</g>
			</svg><svg version="1.1" id='menuShareButton' viewBox="0 0 512 512" class='menuButton'
				onclick="promptShare();">
				<g>
					<circle cx="256" cy="256" r="180" style="fill:none;stroke:#fff;stroke-width:16;" />
					<text style="font-size:120px;fill:#fff;stroke:none;" x="130" y="300">Share</text>
				</g>
			</svg>
		-->
		</div>
		<!--<div id='eqbars'>
			<svg version="1.1" id='svgBars' viewBox="0 0 20 20" preserveAspectRatio="none">
				<g style="fill:#9cf;stroke-width:0;" id='barGroups'>
				</g>
			</svg>
		</div>-->
		<div id='diceDiv'>


			<!-- <svg version="1.1" class='diceButton' id='svgdrums' viewBox="0 0 512 512" height="512" width="512">
				
				<g id='roundDrums'>
					<circle cx="256" cy="256" r="248" style="fill:none;stroke:#00ffff;stroke-width:16;" />
					<rect y="256" x="8" height="16" width="256" style="fill:#00ffff;stroke-width:0;" />
					<text style="font-size:96px;fill:#00ffff;stroke:none;" x="47.71637" y="240.6649">Drums</text>
				</g>
			</svg>-->
			<div id='startGenRow'>
				<input type="image" src='buttonDice.png' id='diceStart' onclick='playRandom();'/>
				<!--
				<svg version="1.1" id='diceStart' viewBox="0 0 512 512" height="512" width="512"
					onclick='playRandom();'>
					<g>
						<circle cx="256" cy="256" r="248" style="fill:none;stroke:#ffffff;stroke-width:16;" />
						<text style="font-size:128px;fill:#ffffff;stroke:none;" x="50" y="300">Random!</text>
					</g>
				</svg>
			-->
			</div>
			<div id='progNameRow'>AAA</div>
			<div id='progSliderRow'>
				<input type="range" min="0" max="999" value="0" class="progSlider" id='sliderProgression'
					onChange='parsChanged();'>
			</div>
			<div id='genControlsRow'>
				<div id='drumBassPart'>
					<svg version="1.1" class='diceButton' id='svgdrums' viewBox="0 0 512 512" height="512" width="512">
						<path d=" M 8 256 A 248 248 200 1 1 256 504" style="fill:none;stroke:#556;stroke-width:4;" />
						<g id='roundDrums'>
							<circle cx="256" cy="256" r="220" style="fill:none;stroke:#ffffff;stroke-width:16;" />
							<rect y="256" x="32" height="16" width="220" style="fill:#ffffff;stroke-width:0;" />
							<text style="font-size:72px;fill:#ffffff;stroke:none;" x="72" y="240">drums</text>
						</g>
					</svg><svg version="1.1" class='diceButton' id='svgbass' viewBox="0 0 512 512" height="512"
						width="512">
						<path d=" M 8 256 A 248 248 200 1 1 256 504" style="fill:none;stroke:#556;stroke-width:4;" />
						<g id='roundBass'>
							<circle cx="256" cy="256" r="220" style="fill:none;stroke:#ffffff;stroke-width:16;" />
							<rect y="256" x="32" height="16" width="220" style="fill:#ffffff;stroke-width:0;" />
							<text style="font-size:72px;fill:#ffffff;stroke:none;" x="72" y="240">bass</text>
						</g>
					</svg>
				</div>
				<div id='riffAuxPart'>
					<svg version="1.1" class='diceButton' id='svglead' viewBox="0 0 512 512" height="512" width="512">
						<path d=" M 8 256 A 248 248 200 1 1 256 504" style="fill:none;stroke:#556;stroke-width:4;" />
						<g id='roundLead'>
							<circle cx="256" cy="256" r="220" style="fill:none;stroke:#ffffff;stroke-width:16;" />
							<rect y="256" x="32" height="16" width="220" style="fill:#ffffff;stroke-width:0;" />
							<text style="font-size:72px;fill:#ffffff;stroke:none;" x="72" y="240">lead</text>
						</g>
					</svg><svg version="1.1" class='diceButton' id='svgpad' viewBox="0 0 512 512" height="512"
						width="512">
						<path d=" M 8 256 A 248 248 200 1 1 256 504" style="fill:none;stroke:#556;stroke-width:4;" />
						<g id='roundPad'>
							<circle cx="256" cy="256" r="220" style="fill:none;stroke:#ffffff;stroke-width:16;" />
							<rect y="256" x="32" height="16" width="220" style="fill:#ffffff;stroke-width:0;" />
							<text style="font-size:72px;fill:#ffffff;stroke:none;" x="72" y="240">pad</text>
						</g>
					</svg>
				</div>
			</div>
			<div class='menuStub'>&nbsp;</div>
		</div>
	</div>
	<script type='text/javascript' src='r3.js'></script>
	<script type='text/javascript'>
		console.log('init');

		var genRiff = new GenRiff();

		var preProgNN = 0;
		var progNN = 0;

		function promptShare() {

		}




		function chords2title(chords) {
			var title = '';
			var dlmtr = '';
			for (var i = 0; i < chords.length; i = i + 2) {
				title = title + dlmtr;
				title = title + chords[i];
				if (chords[i] != chords[i + 1]) {
					title = title + chords[i + 1];
				}
				dlmtr = '-';
			}
			return title;
		}

		function parsChanged() {
			genRiff.initAudio();
			readChanged();
			startPlay();
		}

		function readChanged() {
			var sz = genRiff.progressions.length;
			var nn = 1 * document.getElementById('sliderProgression').value;
			var r = Math.floor(sz * nn / 1000);
			//document.getElementById(infoName).innerHTML = '' + r + ': ' + genRiff.progressions[r].category + ' / ' + genRiff.progressions[r].name;

			progNN = nn;
			//updateColors();
			document.getElementById('progNameRow').innerHTML = chords2title(genRiff.progressions[r].chords);
			//console.log(genRiff.progressions[r]);
			genRiff.playInfo = genRiff.generateAll(progNN, dr.value, bs.value, ld.value, pd.value);
			if (preProgNN != progNN) {
				//genRiff.pausePlay();
				genRiff.nextBeat = 0;
				genRiff.player.cancelQueue(genRiff.audioContext);
			}
			preProgNN = progNN;

		}

		function clickPlay() {
			//parsChanged();
			if (genRiff.onAir) {
				pausePlay();
			} else {
				startPlay();
			}
		}

		function startPlay() {
			//console.log('startPlay', genRiff.onAir);
			genRiff.initAudio();
			//genRiff.player.cancelQueue(genRiff.audioContext);
			genRiff.startPlay(progNN, dr.value, bs.value, ld.value, pd.value);
			//document.getElementById('playButtonText').textContent = 'Stop';
			document.getElementById('menuPlayButton').src = 'buttonPause.png';
			

			return null;
		}

		function pausePlay() {
			genRiff.pausePlay();
			//document.getElementById('playButtonText').textContent = 'Play';
			document.getElementById('menuPlayButton').src = 'buttonPlay.png';
			return null;
		}

		function playRandom() {
			genRiff.initAudio();
			document.getElementById('sliderProgression').value = Math.floor(1000 * Math.random());
			dr.setValue(Math.floor(1000 * Math.random()));
			bs.setValue(Math.floor(1000 * Math.random()));
			ld.setValue(Math.floor(1000 * Math.random()));
			pd.setValue(0);
			if (Math.random() > 0.5) {
				pd.setValue(Math.floor(1000 * Math.random()));
			}
			parsChanged();
			//genRiff.pausePlay();
			//startPlay();
		}

		function inputval(maincomp, rocomp, onclick, onchange) {
			let me = this;
			this.value = 0;
			this.click = onclick;
			this.change = onchange;
			this.rotation = rocomp;
			this.component = maincomp;
			this.startY = 0;
			this.delta = 0;
			this.startValue = 0;
			//this.noClick = false;
			this.setValue = function (n) {
				var o = this.value;
				this.value = n;
				this.rotation.style.transform = "rotate(" + n * 360 / (332 * 4) + "deg)";
				if (o != n) {
					this.change(this.value);
				}
			}
			this.cmousedown = function (mouseEvent) {
				mouseEvent.preventDefault();
				this.startY = mouseEvent.clientY;
				window.addEventListener('mouseup', this.bUp, false);
				window.addEventListener('mousemove', this.bMove, true);
				this.startValue = this.value;
				//this.noClick = false;

				this.delta = 0;
			}
			this.rakeMouseUp = function (mouseEvent) {
				mouseEvent.preventDefault();
				window.removeEventListener('mousemove', this.bMove, true);
				window.removeEventListener('mouseup', this.bUp, true);
				//if (!this.noClick) {
				//	this.click();
				//}
				if (this.delta < 10) {
					this.click();
				}
			};
			this.rakeMouseMove = function (mouseEvent) {
				mouseEvent.preventDefault();
				var dY = mouseEvent.clientY - this.startY;
				this.delta = Math.abs(dY);
				var newVal = Math.floor(this.startValue - dY / 1);
				if (newVal >= 0 && newVal < 1000) {
					this.setValue(this.startValue - dY / 1);
				}
				//if (Math.abs(dY) > 10) {
				//	this.noClick = true;
				//}
			};

			this.ctouchstart = function (touchEvent) {
				touchEvent.preventDefault();
				this.startY = touchEvent.touches[0].clientY;
				this.startValue = this.value;
				//this.noClick = false;
				this.delta = 0;
			}
			this.ctouchmove = function (touchEvent) {
				touchEvent.preventDefault();
				var dY = touchEvent.touches[0].clientY - this.startY;
				this.delta = Math.abs(dY);
				var newVal = Math.floor(this.startValue - dY / 1);
				if (newVal >= 0 && newVal < 1000) {
					this.setValue(this.startValue - dY / 1);
				}
				//if (Math.abs(dY) > 10) {
				//	this.noClick = true;
				//}
				/*if (Math.abs(dY) < 10) {
					this.click();
				}*/
			}
			this.ctouchend = function (touchEvent) {
				touchEvent.preventDefault();
				//if (!this.noClick) {
				//	this.click();
				//}
				if (this.delta < 10) {
					this.click();
				}
			}
			this.bUp = this.rakeMouseUp.bind(me);
			this.bMove = this.rakeMouseMove.bind(me);
			this.component.addEventListener('mousedown', this.cmousedown.bind(this), false);
			this.component.addEventListener("touchstart", this.ctouchstart.bind(this), false);
			this.component.addEventListener("touchmove", this.ctouchmove.bind(this), false);
			this.component.addEventListener("touchend", this.ctouchend.bind(this), false);
			return me;
		}

		var dr = new inputval(document.getElementById('svgdrums'), document.getElementById('roundDrums'), function () {
			dr.setValue(Math.floor(Math.random() * 1000));
			parsChanged();
		}, function (nn) {
			//console.log(genRiff.onAir,ds.value);
			if (genRiff.onAir)
				parsChanged();
		});
		var bs = new inputval(document.getElementById('svgbass'), document.getElementById('roundBass'), function () {
			bs.setValue(Math.floor(Math.random() * 1000));
			parsChanged();
		}, function (nn) {
			if (genRiff.onAir)
				parsChanged();
		});
		var ld = new inputval(document.getElementById('svglead'), document.getElementById('roundLead'), function () {
			ld.setValue(Math.floor(Math.random() * 1000));
			parsChanged();
		}, function (nn) {
			if (genRiff.onAir)
				parsChanged();
		});
		var pd = new inputval(document.getElementById('svgpad'), document.getElementById('roundPad'), function () {
			pd.setValue(Math.floor(Math.random() * 1000));
			parsChanged();
		}, function (nn) {
			if (genRiff.onAir)
				parsChanged();
		});
		readChanged();

		/*var barGroups=document.getElementById('barGroups');
		var sz=barGroups.children.length;
		for(var i=0;i<sz;i++){
			var rr=barGroups.children[i];
			//console.log(i,rr);
			//console.dir(rr);
			//rr.height=1+i;
			rr.setAttribute("height", ''+i+"px");
		}*/
		//console.log(barGroups.children.length,barGroups.children[0]);
		/*var svgns = "http://www.w3.org/2000/svg";
		var barGroups = document.getElementById('barGroups');
		for (var i = 0; i < 20; i++) {
			var rect = document.createElementNS(svgns, 'rect');
			rect.setAttributeNS(null, 'x', i + 'px');
			rect.setAttributeNS(null, 'y', 0 + 'px');
			rect.setAttributeNS(null, 'height', '1px');
			rect.setAttributeNS(null, 'width', '0.95px');
			barGroups.appendChild(rect);
		}*/
	</script>
</body>

</html>